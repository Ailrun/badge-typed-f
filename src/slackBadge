const process = require('process');

const fetch = require('node-fetch');
const queryString = require('query-string');

module.exports = async function (req, res) {
  const members = await getMembers();

  const [
    active,
    total,
  ] = members
    .filter(isUser)
    .reduce((acc, member) => [
      isActive(member) ?
        acc[0] + 1 :
        acc[0],
      acc[1] + 1,
    ], [0, 0]);

  const query = queryString.stringify(req.query);
  const badge = await getBadge({ active, total, query });

  res.set('Content-Type', 'image/svg+xml');
  res.send(badge);
};

async function getMembers() {
  const token = process.env.SLACK_WORKSPACE_TOKEN;
  const response = await fetch('https://typed-f.slack.com/api/users.list', {
    headers: {
      Authorization: 'Bearer ' + token,
    },
  });
  const body = await response.json();
  return body.members;
}

async function getBadge({ active, total, query }) {
  const response = await fetch(`https://img.shields.io/badge/slack-${active}%2F${total}-hotpink.svg?${query}`);
  return response.text();
}

function isUser(member) {
  return !member.is_bot &&
    !member.is_app_user &&
    member.name !== 'slackbot';
}

function isActive(member) {
  return !member.deleted;
}
